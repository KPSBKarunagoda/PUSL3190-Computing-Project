<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detailed Analysis - PhishGuard</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <style>
    body.dark-theme {
      padding-top: 80px;
      padding-bottom: 80px;
    }
    
    /* Header Navigation Styles */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      padding: 0 30px;
      height: 60px;
    }
    
    .top-header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 100%;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
    }
    
    .logo {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    
    .logo i {
      font-size: 1.4rem;
    }
    
    .header-nav {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .header-nav-item {
      color: var(--text-primary);
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 4px;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .header-nav-item:hover {
      background-color: rgba(61, 133, 198, 0.1);
      color: var(--primary-color);
    }
    
    .header-nav-item.active {
      color: var(--primary-color);
      background-color: rgba(61, 133, 198, 0.1);
    }
    
    /* Main container */
    .details-container {
      max-width: 1150px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Header section */
    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }
    
    .details-header:after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100px;
      height: 3px;
      background-color: var(--primary-color);
      border-radius: 3px;
    }
    
    .details-header h1 {
      font-size: 2rem;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
      color: var(--text-primary);
    }
    
    .details-header i {
      color: var(--primary-color);
    }
    
    /* Content cards */
    .details-card {
      background-color: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      overflow: hidden;
      margin-bottom: 30px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .details-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
    }
    
    .details-section {
      padding: 30px;
      position: relative;
    }
    
    /* URL summary card */
    .url-summary {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(145deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.05));
      border-radius: 12px;
    }
    
    .url-score {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
      background-color: rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
      flex-shrink: 0;
    }
    
    .score-high {
      background: linear-gradient(45deg, #f44336, #ff5252);
      color: white;
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }
    
    .score-medium {
      background: linear-gradient(45deg, #ff9800, #ffb74d);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }
    
    .score-low {
      background: linear-gradient(45deg, #4caf50, #81c784);
      color: white;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .url-details {
      flex: 1;
    }
    
    .url-details h3 {
      margin-top: 0;
      color: var(--text-primary);
      font-size: 1.3rem;
      margin-bottom: 5px;
    }
    
    .url-display {
      font-family: monospace;
      word-break: break-all;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      border-left: 4px solid var(--primary-color);
    }
    
    /* AI explanation section */
    .ai-explanation {
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      background-color: rgba(61, 133, 198, 0.05);
      border-left: 4px solid var(--primary-color);
    }
    
    .ai-explanation-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .ai-explanation-header i {
      font-size: 1.5rem;
      color: var(--primary-color);
    }
    
    .ai-explanation-content {
      line-height: 1.7;
      color: var(--text-secondary);
    }
    
    /* Loading state */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }
    
    .loading-spinner {
      margin-bottom: 20px;
    }
    
    .loading-spinner i {
      font-size: 2.5rem;
      color: var(--primary-color);
      animation: spin 1.5s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Markdown rendering styles */
    .markdown-content {
      color: var(--text-secondary);
      line-height: 1.8;
    }
    
    .markdown-content h1 {
      font-size: 1.8rem;
      margin-top: 30px;
      margin-bottom: 20px;
      color: var(--text-primary);
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .markdown-content h2 {
      font-size: 1.5rem;
      margin-top: 25px;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .markdown-content h3 {
      font-size: 1.3rem;
      margin-top: 20px;
      margin-bottom: 12px;
      color: var(--accent-color);
    }
    
    .markdown-content p {
      margin: 15px 0;
    }
    
    .markdown-content ul {
      margin: 15px 0;
      padding-left: 20px;
    }
    
    .markdown-content li {
      margin-bottom: 8px;
    }
    
    .markdown-content code {
      background-color: rgba(0, 0, 0, 0.2);
      padding: 3px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
    
    .markdown-content pre {
      background-color: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 20px 0;
    }
    
    .markdown-content blockquote {
      border-left: 4px solid var(--primary-color);
      padding-left: 15px;
      margin: 20px 0;
      color: var(--text-tertiary);
    }
    
    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      overflow: hidden;
      border-radius: 8px;
    }
    
    .markdown-content th,
    .markdown-content td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }
    
    .markdown-content th {
      background-color: rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
    }
    
    .markdown-content tr:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }

    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
    }
    
    .btn-secondary {
      background-color: rgba(0, 0, 0, 0.2);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      background-color: rgba(0, 0, 0, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }
    
    .btn-primary {
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      color: white;
      border: none;
    }
    
    .btn-primary:hover {
      filter: brightness(110%);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(61, 133, 198, 0.25);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    /* Technical details section */
    .technical-section {
      margin-top: 30px;
      padding: 20px;
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 12px;
    }
    
    .technical-section h3 {
      margin-top: 0;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .technical-section h3 i {
      color: var(--accent-color);
    }
    
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .feature-item {
      padding: 15px;
      background-color: rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
    }
    
    .feature-name {
      color: var(--text-secondary);
    }
    
    .feature-value {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .feature-value-true {
      color: #f44336;
    }
    
    .feature-value-false {
      color: #4caf50;
    }
    
    .feature-value-neutral {
      color: var(--text-primary);
    }

    /* Error state */
    .error-state {
      padding: 30px;
      text-align: center;
      border-radius: 12px;
      background-color: rgba(244, 67, 54, 0.05);
      border: 1px solid rgba(244, 67, 54, 0.2);
      margin: 20px 0;
    }
    
    .error-state i {
      font-size: 3rem;
      color: #f44336;
      margin-bottom: 15px;
    }
    
    .error-state h3 {
      color: #f44336;
      margin-bottom: 15px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .url-summary {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      .features-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
  <link rel="stylesheet" href="footer-styles.css">
</head>
<body class="dark-theme">
  <header class="top-header">
    <div class="top-header-content">
      <div class="logo-container">
        <a href="index.html" class="logo">
          <i class="fas fa-shield-alt"></i>
          <span>PhishGuard</span>
        </a>
      </div>
      <nav class="header-nav">
        <a href="dashboard.html" class="header-nav-item">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="analyze.html" class="header-nav-item active">
          <i class="fas fa-search"></i> Analyze
        </a>
        <a href="settings.html" class="header-nav-item">
          <i class="fas fa-cog"></i> Settings
        </a>
      </nav>
    </div>
  </header>

  <div class="details-container">
    <div class="details-header">
      <h1><i class="fas fa-chart-bar"></i> Detailed Analysis</h1>
      <a href="analyze.html" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Analysis
      </a>
    </div>

    <!-- Main Content Card -->
    <div class="details-card" id="main-content">
      <div class="details-section" id="loading-container">
        <div class="loading-state">
          <div class="loading-spinner">
            <i class="fas fa-circle-notch fa-spin"></i>
          </div>
          <h2>Generating Detailed Analysis</h2>
          <p>Our AI is analyzing the security characteristics of this URL. This may take a few moments...</p>
        </div>
      </div>

      <div class="details-section" id="error-container" style="display: none;">
        <div class="error-state">
          <i class="fas fa-exclamation-circle"></i>
          <h3>Unable to Generate Analysis</h3>
          <p id="error-message">There was an error generating the detailed analysis. Please try again later.</p>
          <div class="action-buttons">
            <button class="btn btn-secondary" id="retry-button">
              <i class="fas fa-redo"></i> Retry Analysis
            </button>
          </div>
        </div>
      </div>

      <div class="details-section" id="results-container" style="display: none;">
        <!-- URL Summary -->
        <div class="url-summary" id="url-summary">
          <div id="risk-score" class="url-score">0</div>
          <div class="url-details">
            <h3 id="risk-level">Analyzing...</h3>
            <div id="analyzed-url" class="url-display">URL: Loading...</div>
            <div id="analysis-date">Analyzed on: Loading...</div>
          </div>
        </div>
        
        <!-- AI-Powered Explanation -->
        <div class="ai-explanation">
          <div class="ai-explanation-header">
            <i class="fas fa-robot"></i>
            <h3>AI-Powered Security Analysis</h3>
          </div>
          <div class="ai-explanation-content">
            <div class="markdown-content" id="ai-content">
              <!-- AI-generated content will appear here -->
            </div>
          </div>
        </div>
        
        <!-- Technical Details Section -->
        <div class="technical-section">
          <h3><i class="fas fa-code"></i> Technical Details</h3>
          <p>These are the specific features extracted from this URL that were used in the analysis:</p>
          <div class="features-grid" id="features-grid">
            <!-- Features will be added dynamically -->
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
          <a href="analyze.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Analysis
          </a>
          <a href="analyze.html" class="btn btn-primary">
            <i class="fas fa-search"></i> Analyze Another URL
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer Section -->
  <footer class="pg-footer">
    <div class="pg-footer-container">
      <div class="pg-footer-column">
        <div class="pg-footer-logo">
          <i class="fas fa-shield-alt"></i>
          <h3>PhishGuard</h3>
        </div>
        <p class="pg-footer-description">
          Protecting users against phishing attacks with advanced detection technology and security education.
        </p>
        <div class="pg-footer-social">
          <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
          <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
          <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
          <a href="#" aria-label="GitHub"><i class="fab fa-github"></i></a>
        </div>
      </div>
      
      <div class="pg-footer-column pg-footer-links">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
          <li><a href="analyze.html"><i class="fas fa-search"></i> URL Analysis</a></li>
          <li><a href="reports.html"><i class="fas fa-flag"></i> Reports</a></li>
          <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
      </div>
      
      <div class="pg-footer-column pg-footer-links">
        <h4>Resources</h4>
        <ul>
          <li><a href="education.html"><i class="fas fa-book"></i> Phishing Education</a></li>
          <li><a href="password-health.html"><i class="fas fa-key"></i> Password Health</a></li>
          <li><a href="#"><i class="fas fa-question-circle"></i> Help Center</a></li>
          <li><a href="#"><i class="fas fa-file-alt"></i> Blog</a></li>
        </ul>
      </div>
      
      <div class="pg-footer-column pg-footer-links">
        <h4>Legal</h4>
        <ul>
          <li><a href="#"><i class="fas fa-shield-alt"></i> Privacy Policy</a></li>
          <li><a href="#"><i class="fas fa-gavel"></i> Terms of Service</a></li>
          <li><a href="#"><i class="fas fa-cookie"></i> Cookie Policy</a></li>
          <li><a href="#"><i class="fas fa-id-card"></i> Contact Us</a></li>
        </ul>
      </div>
    </div>
    
    <div class="pg-footer-copyright">
      <p>&copy; 2025 PhishGuard</p>
    </div>
  </footer>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Check if user is logged in
      const token = localStorage.getItem('phishguardToken');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      // Get URL parameter if present (for direct access or sharing)
      const urlParams = new URLSearchParams(window.location.search);
      const urlToAnalyze = urlParams.get('url');
      
      // Get analysis data from session storage (when coming from analyze.html)
      const analysisDataJson = sessionStorage.getItem('analysisData');
      
      try {
        let analysisData;
        
        // CASE 1: We have data in sessionStorage (came from analyze page)
        if (analysisDataJson) {
          analysisData = JSON.parse(analysisDataJson);
        } 
        // CASE 2: We have a URL parameter but no session data (direct access)
        else if (urlToAnalyze) {
          // Show loading state while we fetch the analysis
          document.getElementById('loading-container').innerHTML = `
            <div class="loading-state">
              <div class="loading-spinner">
                <i class="fas fa-circle-notch fa-spin"></i>
              </div>
              <h2>Analyzing URL</h2>
              <p>Please wait while we analyze: ${urlToAnalyze}</p>
            </div>
          `;
          
          // Perform the analysis directly
          analysisData = await analyzeUrlDirectly(urlToAnalyze, token);
        } 
        // CASE 3: No data source available
        else {
          throw new Error('No URL specified. Please provide a URL to analyze.');
        }

        const url = analysisData.url;
        const features = analysisData.features || {};
        const result = analysisData.result;
        
        if (!url || !result) {
          throw new Error('Invalid analysis data');
        }
        
        // Update URL summary section
        document.getElementById('analyzed-url').textContent = `URL: ${url}`;
        document.getElementById('analysis-date').textContent = `Analyzed on: ${new Date(result.timestamp || new Date()).toLocaleString()}`;
        
        const riskScore = result.risk_score || 0;
        const riskScoreElement = document.getElementById('risk-score');
        riskScoreElement.textContent = riskScore;
        riskScoreElement.className = 'url-score';
        
        const riskLevelElement = document.getElementById('risk-level');
        
        if (result.is_phishing || riskScore > 70) {
          riskScoreElement.classList.add('score-high');
          riskLevelElement.textContent = 'High Risk Detected';
          riskLevelElement.style.color = '#f44336';
        } else if (riskScore > 30) {
          riskScoreElement.classList.add('score-medium');
          riskLevelElement.textContent = 'Medium Risk Detected';
          riskLevelElement.style.color = '#ff9800';
        } else {
          riskScoreElement.classList.add('score-low');
          riskLevelElement.textContent = 'Low Risk Detected';
          riskLevelElement.style.color = '#4caf50';
        }
        
        // Populate technical features grid
        populateFeaturesGrid(features);
        
        // Get AI-powered explanation
        try {
          console.log('Fetching AI explanation for URL:', url);
          
          // Show loading indicator with helpful message
          const aiContentElement = document.getElementById('ai-content');
          aiContentElement.innerHTML = `
            <div class="loading-state">
              <div class="loading-spinner">
                <i class="fas fa-circle-notch fa-spin"></i>
              </div>
              <p>Generating AI analysis...</p>
              <p class="loading-subtext" style="font-size: 0.9rem; opacity: 0.8">This may take up to a minute. If it takes longer, we'll use our built-in analysis instead.</p>
            </div>
          `;
          
          // Implement retries with increasing timeout
          const getExplanationWithRetry = async (maxRetries = 1) => {
            let retryCount = 0;
            
            while (retryCount <= maxRetries) {
              const controller = new AbortController();
              const timeoutMs = retryCount === 0 ? 45000 : 30000; // 45s first try, 30s retry
              
              const timeoutId = setTimeout(() => {
                console.log(`AI explanation request timed out after ${timeoutMs/1000} seconds (attempt ${retryCount + 1})`);
                controller.abort();
              }, timeoutMs);
              
              try {
                const aiResponse = await fetch('/api/education/detailed-analysis', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'x-auth-token': token
                  },
                  body: JSON.stringify({
                    url,
                    analysisResult: { 
                      risk_score: result.risk_score,
                      is_phishing: result.is_phishing,
                      risk_explanation: result.risk_explanation || '',
                      ml_confidence: result.ml_confidence || 0,
                      // Only include the most important features instead of all
                      features: {
                        tls_ssl_certificate: features.tls_ssl_certificate,
                        domain_in_ip: features.domain_in_ip,
                        domain_google_index: features.domain_google_index,
                        url_google_index: features.url_google_index,
                        qty_redirects: features.qty_redirects,
                        time_domain_activation: features.time_domain_activation,
                        url_shortened: features.url_shortened,
                        // Omit other less important features to reduce payload size
                      }
                    }
                  }),
                  signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!aiResponse.ok) {
                  throw new Error(`Server returned ${aiResponse.status}`);
                }
                
                const aiData = await aiResponse.json();
                
                if (aiData.success && aiData.explanation) {
                  return aiData.explanation;
                } else {
                  throw new Error(aiData.error || 'Invalid response');
                }
              } catch (error) {
                clearTimeout(timeoutId);
                
                if (retryCount >= maxRetries || error.name === 'AbortError') {
                  throw error;
                }
                
                console.log(`Retrying AI explanation (${retryCount + 1}/${maxRetries})...`);
                retryCount++;
                
                // Wait before retrying
                await new Promise(r => setTimeout(r, 1000));
              }
            }
          };
          
          // Try to get AI explanation with one retry
          try {
            const explanation = await getExplanationWithRetry(1);
            
            // Render the explanation
            aiContentElement.innerHTML = marked.parse(explanation.explanation || explanation);
            
            // Show results container
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
            console.log('AI explanation rendered successfully');
          } catch (error) {
            console.error('AI explanation error:', error);
            
            // Provide more helpful error information
            if (error.name === 'AbortError') {
              console.warn('AI explanation request timed out. Using fallback explanation.');
            }
            
            // Always use fallback if there's any error
            console.log('Generating fallback explanation');
            const fallbackExplanation = generateFallbackExplanation(url, result, features);
            aiContentElement.innerHTML = marked.parse(fallbackExplanation);
            
            // Make sure we always show the results container
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
          }
        } catch (outerError) {
          console.error('Outer AI explanation error:', outerError);
          
          // Handle any unexpected errors in the outer try block
          const aiContentElement = document.getElementById('ai-content');
          const fallbackExplanation = generateFallbackExplanation(url, result, features);
          aiContentElement.innerHTML = marked.parse(fallbackExplanation);
          
          document.getElementById('loading-container').style.display = 'none';
          document.getElementById('results-container').style.display = 'block';
        }
        
        // Update URL with analyzed URL for sharing
        if (!window.location.search.includes('url=')) {
          const shareUrl = new URL(window.location.href);
          shareUrl.searchParams.set('url', url);
          window.history.replaceState({}, '', shareUrl);
        }
      } catch (error) {
        console.error('Error processing analysis data:', error);
        showError('Error processing analysis data: ' + error.message);
      }
    });

    /** 
     * Analyze a URL directly without going through analyze.html
     * @param {string} url - The URL to analyze
     * @param {string} token - Auth token
     * @returns {Promise<Object>} Analysis data in the same format as sessionStorage
     */
    async function analyzeUrlDirectly(url, token) {
      try {
        const response = await fetch('http://localhost:3000/analyze-url', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          },
          body: JSON.stringify({ 
            url: url,
            useSafeBrowsing: true
          })
        });
        if (!response.ok) {
          throw new Error('Failed to analyze URL');
        }
        const result = await response.json();
        
        // Format the result in the same structure as what would be in sessionStorage
        return {
          url: url,
          features: result.features || result.ml_result?.features || {},
          result: {
            risk_score: typeof result.risk_score === 'number' ? 
              (result.risk_score > 1 ? result.risk_score : result.risk_score * 100) : 0,
            is_phishing: result.is_phishing || false,
            ml_confidence: result.ml_confidence || result.ml_result?.confidence || 0,
            risk_explanation: result.risk_explanation || result.message || "",
            timestamp: new Date().toISOString()
          }
        };
      } catch (error) {
        throw new Error(`Failed to analyze URL: ${error.message}`);
      }
    }

    function populateFeaturesGrid(features) {
      const featuresGrid = document.getElementById('features-grid');
      featuresGrid.innerHTML = '';

      // Sort features alphabetically for better organization
      const sortedFeatures = Object.keys(features).sort();
        
      // Add each feature to the grid
      sortedFeatures.forEach(feature => {
        const value = features[feature];
        let displayValue = value;
        let valueClass = 'feature-value-neutral';

        // Skip internal properties
        if (feature === '_url' || feature.startsWith('_')) {
          return;
        }

        // Format boolean values
        if (value === true || value === 1 || value === '1') {
          displayValue = 'Yes';
          
          // Some features are good when true, some are bad
          if (feature.includes('google_index') || feature.includes('https') || 
              feature.includes('spf') || feature.includes('ssl_certificate')) {
            valueClass = 'feature-value-false'; // Green for good
          } else {
            valueClass = 'feature-value-true'; // Red for bad
          }
        } else if (value === false || value === 0 || value === '0') {
          displayValue = 'No';
          
          // Some features are good when false, some are bad
          if (feature.includes('google_index') || feature.includes('https') || 
              feature.includes('spf') || feature.includes('ssl_certificate')) {
            valueClass = 'feature-value-true'; // Red for bad
          } else {
            valueClass = 'feature-value-false'; // Green for good
          }
        }

        // Create feature item element
        const featureItem = document.createElement('div');
        featureItem.className = 'feature-item';
        featureItem.innerHTML = `
          <div class="feature-name">${formatFeatureName(feature)}</div>
          <div class="feature-value ${valueClass}">${displayValue}</div>
        `;

        featuresGrid.appendChild(featureItem);
      });

      // If no features, show a message
      if (sortedFeatures.length === 0) {
        featuresGrid.innerHTML = '<p>No specific features available for this URL.</p>';
      }
    }

    function formatFeatureName(name) {
      // Convert snake_case to Title Case with spaces
      return name.split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function showError(message) {
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-container').style.display = 'block';
      document.getElementById('retry-button').addEventListener('click', () => {
        window.location.href = 'analyze.html';
      });
    }

    function generateFallbackExplanation(url, result, features) {
      const riskScore = result.risk_score || 0;
      const isPhishing = result.is_phishing || false;
      
      // Build more comprehensive fallback explanation
      const hasSslCertificate = features.tls_ssl_certificate !== 0;
      const isIpBased = features.domain_in_ip === 1;
      const isIndexed = features.domain_google_index === 1;
      const urlIsIndexed = features.url_google_index === 1;
      const hasRedirects = features.qty_redirects > 0;
      const domainAge = features.time_domain_activation || 0;
      const urlShortened = features.url_shortened === 1;
      
      let securityFactors = '';
      
      // Check for IP-based URL (highest risk indicator)
      if (isIpBased) {
        securityFactors += '* **IP Address Used Instead of Domain**: The URL uses a numeric IP address rather than a domain name, which is unusual for legitimate websites\n';
      }
      
      // Check for SSL certificate
      if (hasSslCertificate === false) {
        securityFactors += '* **Missing Security Certificate**: This site does not use HTTPS encryption which makes it vulnerable to data interception\n';
      } else if (hasSslCertificate) {
        securityFactors += '* **Secure Connection**: This site uses HTTPS encryption to protect your data\n';
      }
      
      // Check if domain is indexed by Google
      if (isIndexed === false) {
        securityFactors += '* **Domain Not Indexed**: This domain is not indexed by search engines, which is unusual for legitimate websites\n';
      } else if (isIndexed) {
        securityFactors += '* **Indexed by Google**: This domain is properly indexed by search engines, typical of established websites\n';
      }
      
      // Check if the specific URL is indexed
      if (urlIsIndexed === false) {
        securityFactors += '* **Page Not Indexed**: This specific URL is not indexed by search engines\n';
      } else if (urlIsIndexed) {
        securityFactors += '* **Page Indexed by Google**: This specific URL is indexed by search engines\n';
      }
      
      // Check for redirects
      if (hasRedirects && features.qty_redirects > 1) {
        securityFactors += `* **Multiple Redirects (${features.qty_redirects})**: This URL contains redirects which can be used to hide the true destination\n`;
      }
      
      // Check for URL shortening
      if (urlShortened) {
        securityFactors += '* **URL Shortening Detected**: This appears to be a shortened URL which can hide the true destination\n';
      }
      
      // Check domain age
      if (domainAge < 30 && domainAge > 0) {
        securityFactors += `* **Very New Domain**: This domain was created only ${domainAge} days ago. Phishing sites often use newly registered domains\n`;
      } else if (domainAge > 365) {
        securityFactors += `* **Established Domain**: This domain has been active for ${Math.floor(domainAge/365)} year(s), which is typical for legitimate websites\n`;
      }

      // If we have no specific factors, add some generic ones
      if (!securityFactors) {
        if (isPhishing || riskScore > 70) {
          securityFactors = '* **Multiple Risk Factors**: This URL exhibits characteristics commonly found in phishing websites\n';
        } else if (riskScore > 30) {
          securityFactors = '* **Some Suspicious Elements**: This URL has some concerning characteristics but isn\'t definitively malicious\n';
        } else {
          securityFactors = '* **Low Risk Profile**: This URL doesn\'t exhibit characteristics typically associated with phishing attempts\n';
        }
      }

      // Generate appropriate markdown based on risk level
      if (isPhishing || riskScore > 70) {
        return `# High Risk URL Detected

## Security Analysis for ${url}

Our analysis indicates this URL has a **high risk score of ${riskScore}/100**. Multiple security concerns were identified that are commonly associated with phishing websites.

### Key Risk Factors:

${securityFactors}

### Recommendation

We strongly advise against visiting this website or entering any personal information. This URL shows multiple characteristics of a phishing attempt.`;
      } else if (riskScore > 30) {
        return `# Medium Risk URL Detected

## Security Analysis for ${url}

Our analysis indicates this URL has a **medium risk score of ${riskScore}/100**. While not definitively malicious, some suspicious characteristics were detected.

### Points of Caution:

${securityFactors}

### Recommendation

Exercise caution when visiting this website. Do not enter sensitive information unless you can verify the site's legitimacy through other means.`;
      } else {
        return `# Low Risk URL Detected

## Security Analysis for ${url}

Our analysis indicates this URL has a **low risk score of ${riskScore}/100**. No significant security concerns were detected.

### Safety Indicators:

${securityFactors}

### Recommendation

This URL appears to be safe based on our analysis. While no significant issues were detected, always practice standard online safety measures when sharing sensitive information online.`;
      }
    }
  </script>
</body>
</html>
