<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URL Analysis - PhishGuard</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body.dark-theme {
      padding-top: 80px;
      padding-bottom: 80px;
    }
    
    /* Header Navigation Styles */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      padding: 0 30px;
      height: 60px;
    }
    
    .top-header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 100%;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
    }
    
    .logo {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    
    .logo i {
      font-size: 1.4rem;
    }
    
    .header-nav {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .header-nav-item {
      color: var(--text-primary);
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 4px;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .header-nav-item:hover {
      background-color: rgba(61, 133, 198, 0.1);
      color: var(--primary-color);
    }
    
    .header-nav-item.active {
      color: var(--primary-color);
      background-color: rgba(61, 133, 198, 0.1);
    }
  </style>
</head>
<body class="dark-theme">
  <header class="top-header">
    <div class="top-header-content">
      <div class="logo-container">
        <a href="index.html" class="logo">
          <i class="fas fa-shield-alt"></i>
          <span>PhishGuard</span>
        </a>
      </div>
      <nav class="header-nav">
        <a href="dashboard.html" class="header-nav-item">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="analyze.html" class="header-nav-item active">
          <i class="fas fa-search"></i> Analyze
        </a>
        <a href="settings.html" class="header-nav-item">
          <i class="fas fa-cog"></i> Settings
        </a>
      </nav>
    </div>
  </header>

  <div class="url-analysis-wrapper">
    <div class="analysis-header">
      <h1><i class="fas fa-search-shield"></i> URL Analysis</h1>
      <a href="dashboard.html" class="btn-new-analysis">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
    
    <!-- URL Analysis Input Card -->
    <div class="analysis-card">
      <div class="input-section" id="analysis-input">
        <h2><i class="fas fa-shield-alt"></i> Check Any URL for Phishing Threats</h2>
        <p>Enter a website address below to analyze it for potential phishing indicators and security risks.</p>
        
        <div class="url-input-container">
          <i class="fas fa-globe url-icon"></i>
          <input type="url" id="url-input" class="url-input-field" placeholder="Enter URL (e.g., https://example.com)" autofocus>
          <button id="analyze-button" class="analyze-btn">
            <i class="fas fa-search"></i> Analyze
          </button>
        </div>
        
        <div id="input-error" class="error-message" style="display: none;">
          <i class="fas fa-exclamation-circle"></i>
          <span>Please enter a valid URL (e.g., https://example.com)</span>
        </div>
        
        <div class="input-footer">
          <div class="input-tips">
            <i class="fas fa-info-circle"></i>
            <span>Tip: Include http:// or https:// for accurate analysis</span>
          </div>
        </div>
      </div>
      
      <!-- Loading Section -->
      <div id="loading-container" class="analysis-loading" style="display: none;">
        <div class="loading-animation">
          <div class="circle"></div>
          <div class="circle"></div>
        </div>
        <div class="loading-message">Analyzing URL</div>
        <div class="loading-details">We're checking for phishing indicators, malicious patterns, and security risks...</div>
        <div class="loading-progress">
          <div class="loading-progress-bar"></div>
        </div>
      </div>
      
      <!-- Results Section -->
      <div id="results-container" class="result-section" style="display: none;">
        <div class="result-header-banner">
          <div id="result-icon-container" class="result-icon-container icon-safe">
            <i id="result-icon" class="fas fa-shield-check"></i>
          </div>
          <div class="result-header-content">
            <h2 id="result-title">Analysis Complete</h2>
            <div id="analyzed-url" class="analyzed-url">URL: https://example.com</div>
          </div>
        </div>
        
        <div class="result-details">
          <div class="score-container">
            <div class="score-header">
              <div class="score-title">Risk Score</div>
              <div id="risk-score-value" class="score-value">0/100</div>
            </div>
            <div class="score-meter">
              <div id="score-fill" class="score-fill score-fill-safe" style="width: 0%"></div>
            </div>
            <div class="score-markers">
              <span>Low Risk</span>
              <span>Medium Risk</span>
              <span>High Risk</span>
            </div>
          </div>
          
          <div class="result-explanation">
            <p id="risk-explanation">This URL has been analyzed for phishing indicators.</p>
          </div>
          
          <div class="result-sections">
            <div class="result-summary">
              <div class="result-summary-header">
                <i class="fas fa-clipboard-list"></i>
                <h3>Analysis Summary</h3>
              </div>
              <div class="result-summary-content" id="analysis-summary">
                <!-- Summary content will be inserted here by JavaScript -->
              </div>
            </div>
          </div>
          
          <div class="result-footer">
            <button id="new-analysis" class="btn-new-analysis">
              <i class="fas fa-redo-alt"></i> Analyze Another URL
            </button>
            <a href="education.html" class="btn-learn-more">
              <i class="fas fa-book"></i> Learn More About Phishing
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Educational Resources Section -->
    <div class="education-container">
      <div class="education-header">
        <i class="fas fa-graduation-cap"></i>
        <h2>Educational Resources</h2>
      </div>
      <div class="education-content">
        <div id="education-content" class="education-placeholder">
          <i class="fas fa-shield-alt"></i>
          <h3>Phishing Protection Tips</h3>
          <p>Complete a URL analysis to get personalized educational content and learn how to protect yourself from common phishing techniques.</p>
        </div>
        
        <div class="resource-cards">
          <div class="resource-card">
            <div class="resource-card-header">
              <i class="fas fa-exclamation-triangle"></i>
              Common Warning Signs
            </div>
            <div class="resource-card-content">
              <p>Learn to identify suspicious URLs, misleading website designs, and other red flags that may indicate a phishing attempt.</p>
              <a href="#" class="resource-link">Read more <i class="fas fa-arrow-right"></i></a>
            </div>
          </div>
          
          <div class="resource-card">
            <div class="resource-card-header">
              <i class="fas fa-lock"></i>
              Stay Protected
            </div>
            <div class="resource-card-content">
              <p>Discover best practices for safe browsing, including using strong passwords and enabling two-factor authentication.</p>
              <a href="#" class="resource-link">Read more <i class="fas fa-arrow-right"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Check if user is logged in
      const token = localStorage.getItem('phishguardToken');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
      
      const urlInput = document.getElementById('url-input');
      const analyzeButton = document.getElementById('analyze-button');
      const inputError = document.getElementById('input-error');
      const loadingContainer = document.getElementById('loading-container');
      const resultsContainer = document.getElementById('results-container');
      const analysisInput = document.getElementById('analysis-input');
      const resultIcon = document.getElementById('result-icon');
      const resultIconContainer = document.getElementById('result-icon-container');
      const resultTitle = document.getElementById('result-title');
      const analyzedUrl = document.getElementById('analyzed-url');
      const scoreFill = document.getElementById('score-fill');
      const riskScoreValue = document.getElementById('risk-score-value');
      const riskExplanation = document.getElementById('risk-explanation');
      const analysisSummary = document.getElementById('analysis-summary');
      const newAnalysisButton = document.getElementById('new-analysis');
      
      // URL validation function
      function isValidUrl(url) {
        try {
          new URL(url);
          return true;
        } catch (e) {
          return false;
        }
      }
      
      // Handle analysis button click
      analyzeButton.addEventListener('click', async () => {
        const url = urlInput.value.trim();
        
        // Reset error
        inputError.style.display = 'none';
        
        // Validate URL
        if (!url) {
          inputError.querySelector('span').textContent = 'Please enter a URL to analyze';
          inputError.style.display = 'flex';
          return;
        }
        
        // Check for valid URL format
        if (!isValidUrl(url)) {
          inputError.querySelector('span').textContent = 'Please enter a valid URL (e.g., https://example.com)';
          inputError.style.display = 'flex';
          return;
        }
        
        // Show loading
        analysisInput.style.display = 'none';
        loadingContainer.style.display = 'flex';
        resultsContainer.style.display = 'none';
        
        try {
          // Send URL for analysis
          const response = await fetch('http://localhost:3000/analyze-url', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-auth-token': token
            },
            body: JSON.stringify({ 
              url: url,
              useSafeBrowsing: true
            })
          });
          
          if (!response.ok) {
            throw new Error('Failed to analyze URL');
          }
          
          const result = await response.json();
          
          // Display results
          displayResults(url, result);
          
        } catch (error) {
          console.error('Analysis error:', error);
          
          // Show error and return to input view
          inputError.querySelector('span').textContent = error.message || 'Failed to analyze URL. Please try again.';
          inputError.style.display = 'flex';
          analysisInput.style.display = 'block';
          loadingContainer.style.display = 'none';
        }
      });
      
      // Display analysis results
      function displayResults(url, result) {
        // Set analyzed URL
        analyzedUrl.textContent = `URL: ${url}`;
        
        // Calculate score
        let score;
        if (result.risk_score > 1) {
          score = Math.min(100, result.risk_score);
        } else {
          score = result.risk_score * 100;
        }
        
        // Round to 1 decimal place
        const displayScore = Math.round(score * 10) / 10;
        riskScoreValue.textContent = `${displayScore}/100`;
        
        // Set risk indicators based on score
        const isHighRisk = score > 60;
        const isMediumRisk = score > 30;
        const mlPrediction = result.ml_result?.prediction || 0;
        
        // Update UI based on risk level
        if (result.is_phishing || (isHighRisk && mlPrediction === 1)) {
          resultIcon.className = 'fas fa-exclamation-triangle';
          resultIconContainer.className = 'result-icon-container icon-danger';
          resultTitle.textContent = 'Phishing Detected!';
          resultTitle.style.color = '#f44336';
          scoreFill.className = 'score-fill score-fill-danger';
        } else if (isMediumRisk || mlPrediction === 1) {
          resultIcon.className = 'fas fa-exclamation-circle';
          resultIconContainer.className = 'result-icon-container icon-warning';
          resultTitle.textContent = 'Caution Advised';
          resultTitle.style.color = '#ff9800';
          scoreFill.className = 'score-fill score-fill-medium';
        } else {
          resultIcon.className = 'fas fa-shield-check';
          resultIconContainer.className = 'result-icon-container icon-safe';
          resultTitle.textContent = 'Likely Safe';
          resultTitle.style.color = '#4caf50';
          scoreFill.className = 'score-fill score-fill-safe';
        }
        
        // Animate score fill
        setTimeout(() => {
          scoreFill.style.width = `${score}%`;
        }, 300);
        
        // Set explanation
        riskExplanation.textContent = result.risk_explanation || 'No detailed explanation available.';
        
        // Create analysis summary
        let summaryHTML = '';
        
        if (result.is_phishing || (isHighRisk && mlPrediction === 1)) {
          summaryHTML = `
            <p><strong>High Risk Detected:</strong> Our analysis indicates this URL has multiple 
            characteristics commonly associated with phishing websites. The risk score 
            of ${displayScore}/100 suggests this may be an attempt to steal sensitive information.</p>
            
            <h4>Risk Indicators:</h4>
            <ul>
              <li>Suspicious URL patterns detected</li>
              <li>Website exhibits common phishing techniques</li>
              ${result.safe_browsing_result?.threats ? '<li><strong>Google Safe Browsing has flagged this website</strong></li>' : ''}
              <li>Risk score: ${displayScore}/100 (High)</li>
            </ul>
            
            <p><strong>Recommendation:</strong> Avoid sharing any personal information with this website.</p>
          `;
        } else if (isMediumRisk) {
          summaryHTML = `
            <p><strong>Moderate Risk Detected:</strong> This URL shows some suspicious characteristics
            but may not be a confirmed phishing site. The risk score of ${displayScore}/100 indicates
            caution is advised when interacting with this website.</p>
            
            <h4>Risk Indicators:</h4>
            <ul>
              <li>Some suspicious elements were detected</li>
              <li>The website has potentially concerning features</li>
              <li>Risk score: ${displayScore}/100 (Medium)</li>
            </ul>
            
            <p><strong>Recommendation:</strong> Proceed with caution and verify the website's legitimacy before sharing any sensitive information.</p>
          `;
        } else {
          summaryHTML = `
            <p><strong>Low Risk Detected:</strong> Our analysis indicates this URL appears to be legitimate
            with a low risk score of ${displayScore}/100. No major phishing indicators were detected.</p>
            
            <h4>Result Summary:</h4>
            <ul>
              <li>No significant phishing indicators found</li>
              <li>URL structure appears normal</li>
              <li>Risk score: ${displayScore}/100 (Low)</li>
            </ul>
            
            <p><strong>Recommendation:</strong> While this URL appears safe, always remain vigilant when sharing personal information online.</p>
          `;
        }
        
        analysisSummary.innerHTML = summaryHTML;
        
        // Show educational content based on the analysis
        loadEducationalContent(result);
        
        // Show results container
        loadingContainer.style.display = 'none';
        resultsContainer.style.display = 'block';
      }
      
      // Load educational content
      async function loadEducationalContent(analysisResult) {
        try {
          const educationContent = document.getElementById('education-content');
          
          // First show loading state
          educationContent.innerHTML = `
            <div class="analysis-loading" style="padding: 30px;">
              <div class="loading-animation" style="width: 50px; height: 50px;">
                <div class="circle"></div>
                <div class="circle"></div>
              </div>
              <p style="margin-top: 20px;">Loading personalized educational content...</p>
            </div>
          `;
          
          // Request content from server
          const response = await fetch('http://localhost:3000/api/education/generate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-auth-token': token
            },
            body: JSON.stringify({
              analysisResult: analysisResult,
              contentType: 'explain'
            })
          });
          
          if (!response.ok) {
            throw new Error('Failed to load educational content');
          }
          
          const data = await response.json();
          
          if (data.success && data.content) {
            educationContent.innerHTML = `
              <div class="education-content-custom">
                <div style="line-height: 1.7; color: var(--text-primary);">
                  ${data.content.replace(/\n/g, '<br>')}
                </div>
              </div>
            `;
          } else {
            throw new Error('Invalid content received');
          }
        } catch (error) {
          console.error('Error loading educational content:', error);
          
          // Fallback content
          const riskLevel = analysisResult.is_phishing ? 'high' : 
                           (analysisResult.risk_score > 0.6 || analysisResult.risk_score > 60) ? 'high' :
                           (analysisResult.risk_score > 0.3 || analysisResult.risk_score > 30) ? 'medium' : 'low';
          
          let educationalHTML = '';
          
          if (riskLevel === 'high') {
            educationalHTML = `
              <h3>Understanding High-Risk Phishing Sites</h3>
              <p>This URL shows multiple indicators commonly associated with phishing attacks. Phishing sites often:</p>
              <ul style="padding-left: 20px; margin: 15px 0; color: var(--text-secondary);">
                <li>Mimic legitimate websites to steal your credentials</li>
                <li>Create a false sense of urgency to prompt immediate action</li>
                <li>Contain spelling or grammatical errors</li>
                <li>Use suspicious domain names that are slightly different from legitimate sites</li>
                <li>Request sensitive personal information</li>
              </ul>
              <p><strong>Always verify the website's legitimacy before entering any personal information.</strong></p>
            `;
          } else if (riskLevel === 'medium') {
            educationalHTML = `
              <h3>Understanding Medium-Risk Websites</h3>
              <p>This URL has some suspicious characteristics but isn't necessarily a phishing site. When dealing with medium-risk sites:</p>
              <ul style="padding-left: 20px; margin: 15px 0; color: var(--text-secondary);">
                <li>Verify the website's identity through other channels</li>
                <li>Check for HTTPS security and a valid certificate</li>
                <li>Be cautious about sharing personal information</li>
                <li>Look for contact information and legitimate privacy policies</li>
              </ul>
              <p><strong>Use caution and your best judgment when interacting with this site.</strong></p>
            `;
          } else {
            educationalHTML = `
              <h3>Safe Browsing Practices</h3>
              <p>This URL appears to be safe, but it's always good to follow these secure browsing habits:</p>
              <ul style="padding-left: 20px; margin: 15px 0; color: var(--text-secondary);">
                <li>Keep your browser and security software updated</li>
                <li>Use strong, unique passwords for different websites</li>
                <li>Enable two-factor authentication when available</li>
                <li>Be careful when clicking on links in emails or messages</li>
                <li>Check website URLs before entering personal information</li>
              </ul>
              <p><strong>Even on safe websites, always be mindful of the information you share online.</strong></p>
            `;
          }
          
          educationContent.innerHTML = educationalHTML;
        }
      }
      
      // New analysis button
      newAnalysisButton.addEventListener('click', () => {
        urlInput.value = '';
        resultsContainer.style.display = 'none';
        loadingContainer.style.display = 'none';
        analysisInput.style.display = 'block';
        inputError.style.display = 'none';
        urlInput.focus();
      });
      
      // Allow Enter key to submit
      urlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          analyzeButton.click();
        }
      });
    });
  </script>
</body>
</html>
